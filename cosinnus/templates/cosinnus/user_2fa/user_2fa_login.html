{% extends "cosinnus/base.html" %}
{% load i18n two_factor cosinnus_tags %}

{% block cosinnus_navbar %}
{% endblock cosinnus_navbar %}

{% block leftnav %}
{% endblock leftnav %}



{% block page_title %}
    {% if two_factor_method == 'backup' %}
	    {% trans "Two-Factor Login (Backup-Token)" as our_page_title %}
	{% else %}
	    {% trans "Two-Factor Login" as our_page_title %}
	{% endif %}
	{{ our_page_title }}
{% endblock %}

{% block main_page %}
    <div class="row">
        <!-- now the content -->
        <div class="col-md-8 col-md-offset-2">
            {% include 'cosinnus/messages.html' %}

		    <form action="." method="post" enctype="multipart/form-data" class="cosinnus-form form-horizontal" role="form">
		        {% csrf_token %}
				{% if request.GET.next %}
					<input type="hidden" name="next" value="{{ request.GET.next }}">
				{% elif request.POST.next %}
				    <input type="hidden" name="next" value="{{ request.POST.next }}">
				{% endif %}
		        
		        <div class="content-box">
		            {{ form.non_field_errors }}
		            
                    <h2>
	                    {% if two_factor_method == 'backup' %}
					        {% trans "Two-Factor Login (Backup-Token)" %}
					    {% else %}
					        {% trans "Two-Factor Login" %}
					    {% endif %}
				    </h2>
		            {% if two_factor_method == 'backup' %}
			            <p class="textfield transparent">
			                {% blocktrans trimmed %}Use this form for entering backup tokens for logging in.
				                These tokens have been generated for you to print and keep safe. Please
				                enter one of these backup tokens to login to your account.{% endblocktrans %}
			            </p>
			        {% else %}
                        <p class="textfield transparent">
                            {% blocktrans trimmed %}Please enter the token generated by your token generator.{% endblocktrans %}
                        </p>
		            {% endif %}
		            
		            {% if two_factor_method == 'backup' %}
		                {% for choice_val, choice_name in form.otp_device.field.choices %}
		                    {% if choice_name == 'backup' %}
		                        <input type="hidden" name="otp_device" id="id_otp_device" value="{{ choice_val }}"/>
		                    {% endif %}
		                {% endfor %}
		            {% else %}
			            <input type="hidden" name="otp_device" id="id_otp_device" value="{{ form.otp_device.field.choices.0.0 }}"/>
		            {% endif %}
		            
		            {% if two_factor_method == 'backup' %}
			            {% trans "Backup-Token" as token_label %}
			            {% captureas token_placeholder %}{% trans "Backup-Token" %}{% endcaptureas %}
			        {% else %}
                        {% trans "Token" as token_label %}
                        {% captureas token_placeholder %}{% trans "Numeric Token (e.g. 123456)" %}{% endcaptureas %}
			        {% endif %}
		            {% include 'cosinnus/fields/default_field.html' with field=form.otp_token label=token_label placeholder=token_placeholder legend=token_legend hide_optional=True %}
		            
		            {% if has_backup_device and not two_factor_method == 'backup' %}
		                <hr class="invisible" />
			            <p class="textfield transparent">
			                {% trans "If you do not have access to your OTP generator app, you may enter one of your generated backup tokens" %}:
			                <a href="{% url "cosinnus:two-factor-auth-token-backup" %}?next={% if request.GET.next %}{{ request.GET.next }}{% endif %}">{% trans "Enter backup token" %}</a>
			            </p>
		            {% endif %}
		            
		        </div>
		
		        <button type="submit" class="btn btn-emphasized btn-autosize">
		            <ul class="media-list">
		                <li class="media">
		                    <span class="pull-left" tabindex="-1">
		                        <i class="fa fa-arrow-right"></i>
		                    </span>
		                    <div class="media-body">
		                        {% if two_factor_method == 'token' %}
		                            {% trans 'Log in' %}
		                        {% elif two_factor_method == 'backup' %}
		                            {% trans "Use Backup Token" %}
		                        {% endif %}
		                    </div>
		                </li>
		            </ul>
		        </button>
		
		        <a class="btn btn-emphasized btn-autosize pull-left no-margin" href="{% url "logout" %}">
		            <ul class="media-list">
		                <li class="media">
		                    <span class="pull-left" tabindex="-1">
		                        <i class="fas fa-sign-out-alt"></i>
		                    </span>
		                    <div class="media-body">
		                        {% trans "Log out" %}
		                    </div>
		                </li>
		            </ul>
		        </a>
		
		    </form>
        </div>
    </div>
{% endblock main_page %}
