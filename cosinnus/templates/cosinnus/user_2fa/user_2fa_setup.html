{% extends "cosinnus/user_2fa/user_2fa_settings.html" %}
{% load i18n cosinnus_tags widget_tweaks %}

{% block breadcrumb %}
        <li class="active"><a href="{% url 'cosinnus:profile-detail' %}">{% trans "Your Profile" %}</a></li>
        <li class="active"><a href="{% url 'cosinnus:two-factor-auth-settings' %}">{% trans "Two-Factor Authentication Settings" %}</a></li>
        <li class="active">{% trans "Two-Factor Authentication Setup" %}</li>
{% endblock %}

{% block content %}

	<div class="content-box">
	    <h3>{% trans "Two-Factor Authentication Setup" %}</h3>
	  {% if wizard.steps.current == 'welcome' %}
	    <p class="textfield transparent">
	        {% blocktrans trimmed %}You are about to take your account security to the next level.{% endblocktrans %}
	    </p>
	    <p class="textfield transparent">
	        {% blocktrans trimmed %}
		        To use Two-Factor Authentication, you need a one-time password (OTP) app. 
		        For example, there is "Free OTP" for your Android phone or "OpenOTP" for iOS. 
		        With these apps you can scan the QR code and then log in with the generated codes.
	        {% endblocktrans %}
        </p>
	</div>
	
      <form action="{% url 'cosinnus:two-factor-auth-setup' %}" {% if request.GET.next %}?next={{ request.GET.next|urlencode }}{% endif %}" method="post">{% csrf_token %}
        {{ wizard.management_form }}
        <button type="submit" class="btn btn-emphasized btn-autosize">
          <ul class="media-list">
              <li class="media">
                  <span class="pull-left" tabindex="-1">
                      <i class="fa fa fa-arrow-right"></i>
                  </span>
                  <div class="media-body">
                      {% trans 'Next' %}
                  </div>
              </li>
          </ul>
        </button>
      </form>
  {% elif wizard.steps.current == 'generator' %}
    <p class="textfield transparent">{% blocktrans trimmed %}Scan the QR code below.
        {% endblocktrans %}</p>
    <p class="transparent"><img src="{{ QR_URL }}" alt="QR Code" /></p>
    <p class="textfield transparent">
        {% trans "You may also enter the Secret Key code directly in your app" %}:
        <code>{{ secret_key }}</code>
    </p>
    <p class="textfield transparent">{% trans "Now, enter the token generated by the app:" %}</p>

    <form action="{% url 'cosinnus:two-factor-auth-setup' %}{% if request.GET.next %}?next={{ request.GET.next|urlencode }}{% endif %}" method="post" class="cosinnus-form">{% csrf_token %}
      <div class="cosinnus-field">
        <div class="cosinnus-field-input regular-field">
          {{ wizard.management_form }}
          {{ wizard.form }}
          {% comment %} We are using the jQuery attribute selector to hide the original form label since it is hardly removable from the source form. {% endcomment %}
          <script>
            $('label[for="id_generator-token"]').hide();
            $('input#id_generator-token').attr('placeholder','{% trans "The generated 6-digit code (for example: 123456)" %}');
          </script>
        </div>
      </div>

      <button type="submit" class="btn btn-emphasized btn-autosize">
        <ul class="media-list">
            <li class="media">
                <span class="pull-left" tabindex="-1">
                    <i class="fa fa fa-arrow-right"></i>
                </span>
                <div class="media-body">
                    {% trans 'Next' %}
                </div>
            </li>
        </ul>
      </button>
    </form>

  {% elif wizard.steps.current == 'validation' %}
    {% if not challenge_succeeded %}
      <p class="alert alert-warning" role="alert">{% blocktrans trimmed %}We've
        encountered an issue with the selected authentication method. Please
        go back and verify that you entered your information correctly, try
        again, or use a different authentication method instead. If the issue
        persists, contact the site administrator.{% endblocktrans %}</p>
    {% endif %}
  {% endif %}
{% endblock %}
