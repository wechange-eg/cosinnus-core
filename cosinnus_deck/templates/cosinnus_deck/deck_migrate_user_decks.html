{% extends "cosinnus_deck/base.html" %}
{% load i18n static cosinnus_tags widget_tweaks thumbnail djajax_tags %}

{% block page_title %}
    {% trans "Migrate Nextcloud Boards" %} - {{ block.super }}
{% endblock page_title %}

{% block content %}
    <h2>{% trans "Migrate your boards from the Nextcloud Deck app to your groups and projects!" %}</h2>
    {% if user_admin_groups %}
        {# show at the start of the migration #}
        <div id="start-frame" style="display: {% if migration_in_progress %}none{% else %}block{% endif %}">
            <div class="textfield transparent">
                <p class="textfield transparent">
                    {% trans "Until now, you have been able to work with boards in the Deck app within the Nextcloud. We have now moved this feature from the cloud directly into the groups and projects so that all users can work with Task Boards even more easily." %}
                </p>
                <p class="textfield transparent">
                    {% trans "If you want to continue using your boards from the Nextcloud Deck app, you must move them to a group or project. To do this, select the target group/project for each of your boards." %}
                </p>
                <p class="textfield transparent">
                    <storng></storn>{% trans "Notes:" %}</storng>
                </p>
                <ul>
                    <li>
                        {% trans "You can only migrate boards for which you have either ‘Owner’ permissions or 'Manage' and ‘Share’ permissions. Therefore, some boards that you had access to in the Nextcloud Deck app may not be displayed here (e.g. because you only have ‘Edit’ permissions). In this case, you should ask the person(s) who have the necessary permissions for the board to perform the migration." %}
                    </li>
                    <li>
                        {% trans "You can only select groups and projects in which you are an admin as the destination for the migration." %}
                    </li>
                    <li>
                        {% trans "If a board does not fit into any of your existing groups and projects in terms of content, you can create a new group or project and then select it as the destination for the migration." %}
                    </li>
                    <li>
                        {% trans "If the group/project you select as the migration destination has not yet activated the new ‘Task Board’ app, the app will be activated as part of the migration. If the app is already activated, the lists and tasks from the migrated board will be appended to the existing lists of the Task Board." %}
                        <strong>{% trans "No content will be overwritten." %}</strong>
                    </li>
                    <li>
                        {% trans "Boards that have already been migrated (by you or another user with the necessary permissions) will continue to appear in the list. There is no indication as to whether a board has already been migrated. This means you can migrate boards to different groups/projects if you wish - or multiple times into the same group/project. If you accidentally migrate a board twice, this is not a problem; you can simply delete the redundant task lists manually." %}
                    </li>
                </ul>
                {# populated by the addDeckSelection js function #}
                <table id="deck-group-selection" class="table">
                    <tr>
                        <th>{% trans "Board from the Nextcloud Deck App" %}</th>
                        <th>{% trans "Group/Project (migration target)" %}</th>
                    </tr>
                </table>
            </div>
            <button class="btn btn-emphasized btn-autosize" onclick="$.cosinnus.startDeckMigration()">
                <ul class="media-list">
                    <li class="media">
                                <span class="pull-left">
                                    <i class="fa fa-check"></i>
                                </span>
                        <div class="media-body">
                            {% trans "Start migration" %}
                        </div>
                    </li>
                </ul>
            </button>
        </div>
    {% else %}
        {# shown if the user does not have admin permission in any group #}
        <div class="textfield transparent">
            <p class="textfield transparent">
                {% trans "You must have admin permissions in a group/project to migrate NextCloud Deck boards." %}
            </p>
        </div>
    {% endif %}
    <div id="status-frame" class="textfield transparent"  style="display: {% if migration_in_progress %}block{% else %}none{% endif %}">
        {# shown when the migration is in progress #}
        <div id="status-in-progress">
            <p class="textfield transparent">
                {% trans "Migration is in progress. It can take a few minutes ..." %}
            </p>
        </div>
        {# shown when the migration has successfully finished #}
        <div id="status-success" style="display: none">
            <p class="textfield transparent">
                {% trans "Migration successfully finished. You can access the migrated boards in the Task Board of the selected groups/projects." %}
            </p>
            <p class="textfield transparent">
                {% trans "Note: You have to add users to a group/project to allow them access to the board." %}
            </p>
        </div>
        {# shown when the migration has failed. #}
        <div id="status-failed" style="display: none">
            <p class="textfield transparent">
                {% trans "An error occurred during the migration. Some boards might not have been fully migrated." %}
            </p>
            <p class="textfield transparent">
                {% trans "Please try again later. If the error persists, please contact our support." %}
            </p>
        </div>
    </div>
    <script>
        (() => {
            const groupSelectLabel = '{% trans "Please Select" %}';
            const migrationInProgress = {% if migration_in_progress %}true{% else %}false{% endif %};
            const csrftoken = Cosinnus.getCookie('csrftoken');
            const userGroups = {{ user_admin_groups|safe }};
            const ncAdmin = '{{ SETTINGS.COSINNUS_CLOUD_NEXTCLOUD_ADMIN_USERNAME }}';
            const ncUrl = '{{ SETTINGS.COSINNUS_CLOUD_NEXTCLOUD_URL }}';
            let userBoards = null;
            let ncToken = null;
            let selectedUserBoards = [];
            let statusUpdateInterval = null;
            function isUserBoard(board) {
                /* Filter for user boards where the user has manage and share permissions. */
                return board.owner.uid !== ncAdmin && board.permissions.PERMISSION_MANAGE && board.permissions.PERMISSION_SHARE;
            }
            async function getUserBoards() {
                /* Get the user boards. */
                try {
                    await fetch(`${ncUrl}/login`, { credentials: "include", mode: "no-cors" });
                    ncToken = await fetch(
                        `${ncUrl}/csrftoken`, {credentials: "include"}
                    ).then(r => r.json()).then(r => r.token);
                    let boards = await fetch(`${ncUrl}/apps/deck/boards?requesttoken=${encodeURIComponent(ncToken)}`, { credentials: "include" }).then(r => r.json());
                    return boards.filter(isUserBoard);
                } catch (error) {
                    console.error(error.message);
                    statusFailed();
                }
            }
            async function addDeckSelection() {
                /* Add group selection for user boards. */
                console.debug('adding deck group selection...');
                try {
                    userBoards = await getUserBoards();
                    let group_select_options = `<option value="">--- ${groupSelectLabel} ---</option>`;
                    userGroups.forEach((group) => {
                        group_select_options += `<option value="${group[0]}">${group[1]}</option>`;
                    });
                    var deck_group_table = document.getElementById("deck-group-selection");
                    userBoards.forEach((board) => {
                        var tr = document.createElement('tr');
                        var board_td = document.createElement('td');
                        board_td.innerHTML = board.title;
                        tr.appendChild(board_td)
                        var group_select_td = document.createElement('td');
                        group_select_td.innerHTML =`<select id="group-select-${board.id}">${group_select_options}</select>`;
                        group_select_td.style.padding = "2px";
                        tr.appendChild(group_select_td)
                        deck_group_table.appendChild(tr);
                    })
                } catch (error) {
                    console.error(error.message);
                    statusFailed();
                }
            }
            async function shareBoardWithAdmin(boardID) {
                /* Share board with admin user such that the migration can continue in the backend. */
                await fetch(`${ncUrl}/apps/deck/boards/${boardID}/acl?requesttoken=${encodeURIComponent(ncToken)}`, {
                    method: "POST",
                    credentials: "include",
                     headers: {
                        "Content-Type": "application/json",
                     },
                    body: JSON.stringify({
                        "type": 0,
                        "participant": ncAdmin,
                        "permissionEdit": false,
                        "permissionShare": false,
                        "permissionManage": false,
                        "boardId": `${boardID}`,
                    })
                }).then((response) => {
                    if (!response.ok) {
                        throw new Error(`shareBoardWithAdmin failed with status ${response.status}`);
                    }
                })
            }
            function statusSuccess() {
                /* Migration successful */
                clearInterval(statusUpdateInterval);
                document.getElementById('status-in-progress').style.display = "none";
                document.getElementById('status-success').style.display = "block";
            }
            function statusFailed() {
                /* Migration failed */
                if (statusUpdateInterval) {
                    clearInterval(statusUpdateInterval);
                }
                document.getElementById('start-frame').style.display = "none";
                document.getElementById('status-frame').style.display = "block";
                document.getElementById('status-in-progress').style.display = "none";
                document.getElementById('status-failed').style.display = "block";
            }
            async function updateStatus() {
                /* Check the migration task status. */
                let response = await fetch('/migrate/user_decks/api/',{
                    headers: {
                        'X-CSRFToken': csrftoken,
                    },
                    mode: 'same-origin',
                }).then(r => r.json());
                let migrationStatus = response.status;
                if (migrationStatus === 'success') {
                    statusSuccess();
                } else if (migrationStatus === 'failed') {
                    statusFailed();
                }
            }
            $.cosinnus['startDeckMigration'] = async function startDeckMigration() {
                /* Start the migration for the selected boards/groups. */
                try {
                    for (const board of userBoards)  {
                        var deck_group_select = document.getElementById(`group-select-${board.id}`);
                        if (deck_group_select.value) {
                            selectedUserBoards.push({"board": board, "group": deck_group_select.value});
                        }
                    }
                    var migrationData = [];
                    for (selectedBoard of selectedUserBoards) {
                        if (!selectedBoard.board.acl.some((acl) => acl.participant.uid === ncAdmin)) {
                            await shareBoardWithAdmin(selectedBoard.board.id);
                        }
                        migrationData.push({"board": Number(selectedBoard.board.id), "group": Number(selectedBoard.group)});
                    }
                    await fetch('/migrate/user_decks/api/',{
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            'X-CSRFToken': csrftoken,
                        },
                        body: JSON.stringify(migrationData),
                        mode: 'same-origin',
                    }).then((response) => {
                        if (!response.ok) {
                            throw new Error(`Starting backend migration failed with status ${response.status}`);
                        }
                    })
                    document.getElementById('start-frame').style.display = "none";
                    document.getElementById('status-frame').style.display = "block";
                    statusUpdateInterval = setInterval(updateStatus, 5000);
                } catch (error) {
                    console.error(error.message);
                    statusFailed();
                }
            }
            if (!migrationInProgress) {
                addDeckSelection();
            } else {
                statusUpdateInterval = setInterval(updateStatus, 5000);
            }
        })();
    </script>
{% endblock content %}
